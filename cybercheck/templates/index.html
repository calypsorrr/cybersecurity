{% extends "layout.html" %}
{% block body %}

<div class="page-header">
  <div>
    <h1 class="display-6">Quick engagement console</h1>
    <p class="page-subtitle">Launch targeted Nmap, Scapy and compliance scans with an audit-friendly workflow. Pivot to the operations dashboard to review telemetry across your authorized scope.</p>
  </div>
  <div class="d-flex flex-column align-items-lg-end gap-2">
    <div class="metric-card p-3">
      <span class="metric-label">Last active scan</span>
      <span class="metric-value" style="font-size:1.25rem;">{{ metrics.last_active_finished }}</span>
      <span class="metric-subtext">Updated automatically from recent activity</span>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Runs logged</span>
      <span class="metric-value">{{ metrics.total_runs }}</span>
      <span class="metric-subtext">Stored in the local SQLite engagement log</span>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Active tooling</span>
      <span class="metric-value">{{ metrics.active_runs }}</span>
      <span class="metric-subtext">Nmap, Scapy or Nikto runs in the recent history</span>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">API endpoint</span>
      <span class="metric-value" style="font-size:1.4rem;">/api/runs</span>
      <span class="metric-subtext">Pull structured JSON for downstream tooling</span>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Primary column -->
  <div class="col-12 col-xxl-7">

    <!-- Active -->
    <div class="card shadow-sm">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <span class="fw-semibold d-block">Active reconnaissance</span>
          <small class="text-muted">Nmap, Scapy and Nikto — requires engagement token</small>
        </div>
        <span class="badge text-bg-danger">Authorized targets only</span>
      </div>
      <div class="card-body">
        <form method="post" action="/run_active" class="vstack gap-3" novalidate>

          <div class="alert alert-warning mb-0" role="alert">
            <div class="fw-semibold">Always verify scope before running active scans.</div>
            <div class="small mb-0">Use the dashboard shortcut on the left to confirm the environment you are targeting.</div>
          </div>

          <hr class="text-muted">

          <div>
            <label class="form-label">Tool</label>
            <select name="tool" id="activeTool" class="form-select" required>
              <option value="nmap">nmap (port + service discovery)</option>
              <option value="nikto">nikto (HTTP vulns)</option>
              <option value="scapy">scapy (ICMP ping)</option>
            </select>
          </div>

          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <label class="form-label">Target</label>
              <input class="form-control" name="target" placeholder="target host or URL" autocomplete="off" required>
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label">Operator</label>
              <input class="form-control" name="user" placeholder="Your name or initials" autocomplete="off">
            </div>
          </div>

          <!-- nmap-only options -->
          <div id="nmapOptions" class="vstack gap-3 d-none">
            <div>
              <label class="form-label">Nmap profile</label>
              <select name="nmap_profile" class="form-select">
                <option value="">(default)</option>
                {% for p in nmap_profiles %}
                  <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Preset scan patterns (e.g., <code>standard</code>, <code>top-ports</code>, <code>vuln-scan</code>).</div>
            </div>

            <div>
              <label class="form-label">Extra args (optional)</label>
              <input class="form-control" name="extra_args" placeholder="Additional nmap args, space-separated">
            </div>
          </div>

          <!-- scapy-only options -->
          <div id="scapyOptions" class="vstack gap-3 d-none">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label">ICMP probes</label>
                <input class="form-control" name="scapy_count" placeholder="Number of probes (default 4)" inputmode="numeric" pattern="\d*">
                <div class="form-text">Sends ICMP echo requests to the target host.</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label">Timeout (seconds)</label>
                <input class="form-control" name="scapy_timeout" placeholder="Reply timeout per probe (default 2.0)" inputmode="decimal">
              </div>
            </div>
          </div>

          <div>
            <label class="form-label">Engagement token</label>
            <input class="form-control" name="engagement_token" placeholder="ENGAGEMENT TOKEN (required)" autocomplete="off" required>
            <div class="form-text">Set <code>ENGAGEMENT_TOKEN</code> in your environment and paste it here for each run.</div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-danger">Run active scan</button>
            <span class="text-muted small align-self-center">Results appear immediately and in the dashboard history.</span>
          </div>
        </form>
      </div>
    </div>

    <!-- Non-intrusive -->
    <div class="card shadow-sm mt-4">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <span class="fw-semibold d-block">Local assurance checks</span>
          <small class="text-muted">Safe to run against your own source tree</small>
        </div>
        <span class="badge text-bg-success">Non-intrusive</span>
      </div>
      <div class="card-body">
        <form method="post" action="/run_non_intrusive" class="vstack gap-3" novalidate>
          <div>
            <label class="form-label">Tool</label>
            <select name="tool" class="form-select" required>
              <option value="bandit">Bandit (static Python)</option>
              <option value="pip-audit">pip-audit (dependencies)</option>
            </select>
          </div>

          <div>
            <label class="form-label">Target</label>
            <select name="target" id="banditTarget" class="form-select">
              <option value="" selected disabled>(choose from project …)</option>
              {% for p in scan_presets %}
                <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
              <option value="__custom__">Custom path… (type below)</option>
            </select>
            <div class="form-text">
              Pick a path from the list or choose <strong>Custom path…</strong> and type it below.
            </div>
          </div>

          <div id="customPathWrap" class="d-none">
            <label class="form-label">Custom path</label>
            <input class="form-control" name="target_custom" placeholder="./ or absolute path" autocomplete="off">
          </div>

          <div>
            <label class="form-label">Exclude paths (Bandit)</label>
            <input class="form-control" name="bandit_exclude"
                   placeholder="comma-separated, e.g. cybercheck/app.py,cybercheck/config.py">
            <div class="form-text">Maps to <code>bandit -x</code>. Relative paths resolved from the app folder.</div>
          </div>

          <div>
            <label class="form-label">Skip rules (Bandit)</label>
            <input class="form-control" name="bandit_skip"
                   placeholder="comma-separated rule IDs, e.g. B404,B603">
            <div class="form-text">Maps to <code>bandit -s</code>. Only for Bandit runs.</div>
          </div>

          <div>
            <label class="form-label">Operator</label>
            <input class="form-control" name="user" placeholder="Your name or initials" autocomplete="off">
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary">Run</button>
            <span class="text-muted small align-self-center">Results appear below and in the dashboard history.</span>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- Secondary column -->
  <div class="col-12 col-xxl-5">
    <div class="card shadow-sm">
      <div class="card-header fw-semibold">Recent runs</div>
      <div class="card-body">
        {% if runs %}
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Tool</th>
                  <th scope="col">Target</th>
                  <th scope="col">Started (UTC)</th>
                </tr>
              </thead>
              <tbody>
              {% for r in runs %}
                <tr>
                  <td class="text-muted">{{ r['id'] }}</td>
                  <td><span class="badge text-bg-secondary">{{ r['tool'] }}</span></td>
                  <td class="text-truncate" style="max-width: 220px;" title="{{ r['target'] }}">{{ r['target'] }}</td>
                  <td class="text-nowrap">{{ r['started_at'] }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">No runs recorded yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mt-4">
      <div class="card-header fw-semibold">API</div>
      <div class="card-body">
        <p class="mb-0">GET <code>/api/runs</code> — returns last runs as JSON.</p>
      </div>
    </div>
  </div>
</div>

<!-- Page-specific JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Enhance the Bandit target select if Choices is available
  if (window.initChoices) { window.initChoices('#banditTarget'); }

  // Custom path toggle
  const sel = document.getElementById('banditTarget');
  const customWrap = document.getElementById('customPathWrap');
  const toggleCustom = () => customWrap.classList.toggle('d-none', sel.value !== '__custom__');
  sel.addEventListener('change', toggleCustom);
  toggleCustom();

  // Active tool option groups
  const activeTool   = document.getElementById('activeTool');
  const nmapOptions  = document.getElementById('nmapOptions');
  const scapyOptions = document.getElementById('scapyOptions');

  const toggleActiveOptions = () => {
    const tool = activeTool.value;
    nmapOptions.classList.toggle('d-none', tool !== 'nmap');
    scapyOptions.classList.toggle('d-none', tool !== 'scapy');
  };
  activeTool.addEventListener('change', toggleActiveOptions);
  toggleActiveOptions();
});
</script>

{% endblock %}

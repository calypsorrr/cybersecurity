{% extends "layout.html" %}
{% block body %}

<div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
  <h1 class="h3 mb-0">CyberCheck — Dashboard</h1>
  <span class="badge text-bg-secondary">Authorized use only</span>
</div>
<p class="text-muted mb-4">Run non-intrusive checks locally or authorized active scans. All runs are logged.</p>

<div class="row g-4">
  <!-- Left column -->
  <div class="col-12 col-lg-6">

    <!-- Non-intrusive -->
    <div class="card shadow-sm">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-semibold">Non-intrusive checks</span>
        <span class="badge text-bg-success">Safe</span>
      </div>
      <div class="card-body">
        <form method="post" action="/run_non_intrusive" class="vstack gap-3" novalidate>
          <div>
            <label class="form-label">Tool</label>
            <select name="tool" class="form-select" required>
              <option value="bandit">Bandit (static Python)</option>
              <option value="pip-audit">pip-audit (dependencies)</option>
            </select>
          </div>

          <div>
            <label class="form-label">Target</label>
            <!-- Enhanced select via Choices.js -->
            <select name="target" id="banditTarget" class="form-select">
              <!-- Disabled placeholder at the top -->
              <option value="" selected disabled>(choose from project …)</option>
              {% for p in scan_presets %}
                <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
              <!-- IMPORTANT: Custom path option at the END -->
              <option value="__custom__">Custom path… (type below)</option>
            </select>
            <div class="form-text">
              Pick a path from the list or choose <strong>Custom path…</strong> and type it below.
            </div>
          </div>

          <div id="customPathWrap" class="d-none">
            <label class="form-label">Custom path</label>
            <input class="form-control" name="target_custom" placeholder="./ or absolute path" autocomplete="off">
          </div>

          <div>
            <label class="form-label">Exclude paths (Bandit)</label>
            <input class="form-control" name="bandit_exclude"
                   placeholder="comma-separated, e.g. cybercheck/app.py,cybercheck/config.py">
            <div class="form-text">Maps to <code>bandit -x</code>. Relative paths resolved from the app folder.</div>
          </div>

          <div>
            <label class="form-label">Skip rules (Bandit)</label>
            <input class="form-control" name="bandit_skip"
                   placeholder="comma-separated rule IDs, e.g. B404,B603">
            <div class="form-text">Maps to <code>bandit -s</code>. Only for Bandit runs.</div>
          </div>

          <div>
            <label class="form-label">Operator</label>
            <input class="form-control" name="user" placeholder="Your name or initials" autocomplete="off">
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-primary">Run</button>
            <span class="text-muted small align-self-center">Results appear below and in history.</span>
          </div>
        </form>
      </div>
    </div>

    <!-- Active -->
    <div class="card shadow-sm mt-4">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-semibold">Active checks</span>
        <span class="badge text-bg-danger">Requires token</span>
      </div>
      <div class="card-body">
        <form method="post" action="/run_active" class="vstack gap-3" novalidate>
          <div>
            <label class="form-label">Tool</label>
            <select name="tool" class="form-select" required>
              <option value="nmap">nmap (port + service discovery)</option>
              <option value="nikto">nikto (HTTP vulns)</option>
            </select>
          </div>

          <div>
            <label class="form-label">Target</label>
            <input class="form-control" name="target" placeholder="target host or URL" autocomplete="off" required>
          </div>

          <div>
            <label class="form-label">Nmap profile</label>
            <select name="nmap_profile" class="form-select">
              <option value="">(default)</option>
              {% for p in nmap_profiles %}
                <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Preset scan patterns (e.g., <code>standard</code>, <code>top-ports</code>, <code>vuln-scan</code>).</div>
          </div>

          <div>
            <label class="form-label">Extra args (optional)</label>
            <input class="form-control" name="extra_args" placeholder="Additional nmap args, space-separated">
          </div>

          <div>
            <label class="form-label">Operator</label>
            <input class="form-control" name="user" placeholder="Your name or initials" autocomplete="off">
          </div>

          <div>
            <label class="form-label">Engagement token</label>
            <input class="form-control" name="engagement_token" placeholder="ENGAGEMENT TOKEN (required)" autocomplete="off" required>
            <div class="form-text">Set <code>ENGAGEMENT_TOKEN</code> in your environment and paste it here for each run.</div>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-danger">Run Active Scan</button>
            <span class="text-muted small align-self-center">Active scans are logged with timestamps.</span>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- Right column -->
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm">
      <div class="card-header fw-semibold">Recent runs</div>
      <div class="card-body">
        {% if runs %}
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Tool</th>
                  <th scope="col">Target</th>
                  <th scope="col">Started (UTC)</th>
                </tr>
              </thead>
              <tbody>
              {% for r in runs %}
                <tr>
                  <td class="text-muted">{{ r['id'] }}</td>
                  <td><span class="badge text-bg-secondary">{{ r['tool'] }}</span></td>
                  <td class="text-truncate" style="max-width: 220px;" title="{{ r['target'] }}">{{ r['target'] }}</td>
                  <td class="text-nowrap">{{ r['started_at'] }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">No runs recorded yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mt-4">
      <div class="card-header fw-semibold">API</div>
      <div class="card-body">
        <p class="mb-0">GET <code>/api/runs</code> — returns last runs as JSON.</p>
      </div>
    </div>
  </div>
</div>

<!-- Page-specific JS -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Initialize Choices on the Bandit Target select (forces dropdown below, adds search)
    const choicesInstance = window.initChoices('#banditTarget');

    // Show/hide the custom path input based on selection
    const sel = document.getElementById('banditTarget');
    const customWrap = document.getElementById('customPathWrap');
    function toggleCustom() {
      const val = sel.value;
      if (val === '__custom__') {
        customWrap.classList.remove('d-none');
      } else {
        customWrap.classList.add('d-none');
      }
    }
    sel.addEventListener('change', toggleCustom);
    toggleCustom(); // initial state
  });
</script>

{% endblock %}

{% extends "layout.html" %}
{% block body %}
  <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
    <div>
      <h1 class="h3 mb-0">SpiderFoot OSINT</h1>
      <p class="text-muted2 mb-0">Pivot across IPs, domains, identities, and crypto footprints with SpiderFoot CLI.</p>
    </div>
    <a class="btn btn-outline-secondary" href="{{ url_for('index') }}">← Back to quick scans</a>
  </div>

  <div class="card shadow-sm">
    <div class="card-header fw-semibold">Search targets</div>
    <div class="card-body">
      <form method="post" action="{{ url_for('spiderfoot_console') }}" class="vstack gap-3">
        <div class="row g-3">
          <div class="col-12 col-lg-4">
            <label class="form-label" for="targetType">What are you searching?</label>
            <select id="targetType" name="target_type" class="form-select" required>
              {% for t in lookup_types %}
                <option value="{{ t.value }}" {% if t.value == target_type %}selected{% endif %}>{{ t.label }}</option>
              {% endfor %}
            </select>
            <div class="form-text">SpiderFoot will auto-detect appropriate modules for the chosen target.</div>
          </div>
          <div class="col-12 col-lg-8">
            <label class="form-label" for="targetValue">Target value</label>
            <input id="targetValue" class="form-control" name="target_value" placeholder="IP, domain, username, or hash" value="{{ target_value }}" required>
            <div class="form-text">Examples: {{ lookup_types | map(attribute='example') | list | join(', ') }}</div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <label class="form-label" for="spiderModules">SpiderFoot modules (optional)</label>
            <input id="spiderModules" class="form-control" name="spiderfoot_modules" placeholder="e.g. sfp_dnsresolve,sfp_shodan" value="{{ modules_raw }}">
            <div class="form-text">Leave blank for SpiderFoot defaults, or restrict to specific modules.</div>
            {% if bundles %}
              <div class="d-flex flex-wrap gap-2 mt-2">
                {% for bundle in bundles %}
                  <button type="button" class="btn btn-outline-secondary btn-sm spider-bundle" data-modules="{{ bundle.modules }}" title="{{ bundle.summary }}">{{ bundle.label }}</button>
                {% endfor %}
              </div>
              <div class="form-text">Click a bundle to prefill the module list.</div>
            {% endif %}
          </div>
          <div class="col-12 col-lg-6">
            <label class="form-label" for="spiderPreset">Scan depth</label>
            <select id="spiderPreset" name="spiderfoot_profile" class="form-select">
              {% for preset in presets %}
                <option value="{{ preset.value }}" {% if preset.value == active_preset %}selected{% endif %} data-modules="{{ preset.modules }}">{{ preset.label }}</option>
              {% endfor %}
            </select>
            <div class="form-text">Choose between fast/basic runs, breach-heavy checks, or all modules.</div>
          </div>
        </div>

        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <label class="form-label" for="sfUser">Operator</label>
            <input id="sfUser" class="form-control" name="user" placeholder="Your name or initials" value="{{ user }}">
          </div>
        </div>

        <div class="d-flex flex-wrap gap-2 align-items-center">
          <button class="btn btn-primary">Run SpiderFoot</button>
          <span class="text-muted2 small">Runs happen in the background; stdout/stderr streams below in real time.</span>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-12 col-xl-8">
      {% if run_status %}
        <div class="card shadow-sm" id="spiderfoot-output" data-run-id="{{ run_id }}">
          <div class="card-header fw-semibold d-flex justify-content-between align-items-center gap-2 flex-wrap">
            <span>Live scan output</span>
            <div class="d-flex align-items-center gap-2">
              <button class="btn btn-outline-danger btn-sm {% if not run_status.running %}d-none{% endif %}" id="spiderfoot-stop">Stop SpiderFoot</button>
              <span class="badge bg-secondary" id="spiderfoot-status-pill">{{ 'running' if run_status.running else 'finished' }}</span>
            </div>
          </div>
          <div class="card-body">
            <div class="text-muted2 small mb-2" id="spiderfoot-meta">
              {% if run_status.running %}
                Streaming stdout/stderr... started at {{ run_status.started_at }}.
              {% else %}
                SpiderFoot scan {{ 'stopped' if run_status.stopped_at else 'finished' }}. Return code: {{ run_status.returncode }} · Started: {{ run_status.started_at }} · Finished: {{ run_status.finished_at }}
              {% endif %}
            </div>
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="small text-muted">Scan progress</span>
                <span class="small fw-semibold" id="spiderfoot-progress-label">{{ run_status.progress or 0 }}%</span>
              </div>
              <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar {{ 'progress-bar-striped progress-bar-animated' if run_status.running else 'bg-success' }}" id="spiderfoot-progress" style="width: {{ run_status.progress or 0 }}%" aria-valuenow="{{ run_status.progress or 0 }}"></div>
              </div>
            </div>
            <div class="alert alert-success {{ 'd-none' if run_status.running else '' }}" role="alert" id="spiderfoot-finished">SpiderFoot scan {{ 'stopped' if run_status.stopped_at else 'finished' }}.</div>
            <h6>Stdout</h6>
            <pre class="result-pre bg-body-tertiary p-3 rounded" id="spiderfoot-stdout">{{ run_status.stdout or 'Awaiting output...' }}</pre>
            <h6>Stderr</h6>
            <pre class="result-pre bg-body-tertiary p-3 rounded" id="spiderfoot-stderr">{{ run_status.stderr or 'No stderr yet.' }}</pre>
          </div>
        </div>
      {% else %}
        <div class="card shadow-sm h-100">
          <div class="card-body d-flex flex-column justify-content-center text-center text-muted2">
            <p class="mb-1">Run a SpiderFoot lookup to see enriched OSINT results here.</p>
            <p class="mb-0 small">Supported: IPs, domains, hostnames, CIDRs, ASNs, email addresses, phone numbers, usernames, names, Bitcoin addresses.</p>
          </div>
        </div>
      {% endif %}
    </div>

    <div class="col-12 col-xl-4">
      <div class="card shadow-sm">
        <div class="card-header fw-semibold">Tips</div>
        <div class="card-body small text-muted2">
          <ul class="mb-3">
            <li>For scoped OSINT, keep module list tight to avoid third-party calls that need API keys.</li>
            <li>Domains and IPs will automatically trigger DNS, network, breach, and reputation modules.</li>
            <li>Use CIDR to sweep infrastructure ranges; ASN to map provider-owned space.</li>
            <li>People and usernames lean on breach corpuses and social footprint modules.</li>
            <li>Crypto searches work best with Bitcoin base58 addresses.</li>
          </ul>
          <p class="mb-1">Looking for the original multi-tool suite? <a href="{{ url_for('index') }}">Go back to App/API + supply chain.</a></p>
        </div>
      </div>
      {% if capabilities %}
        <div class="card shadow-sm mt-3">
          <div class="card-header fw-semibold">Capability map</div>
          <div class="card-body small text-muted2">
            <div class="vstack gap-2">
              {% for cap in capabilities %}
                <div>
                  <div class="fw-semibold">{{ cap.title }}</div>
                  <ul class="mb-0">
                    {% for item in cap.items %}
                      <li>{{ item }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>

  {% if presets %}
    <div class="card mt-3 shadow-sm">
      <div class="card-header fw-semibold">Presets explained</div>
      <div class="card-body small text-muted2">
        <ul class="mb-0">
          {% for preset in presets %}
            <li><strong>{{ preset.label }}</strong>: {{ preset.description }}</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  {% if run_status %}
    <script>
      const spiderPresetSelect = document.querySelector('#spiderPreset');
      const spiderModulesInput = document.querySelector('#spiderModules');
      const runId = document.querySelector('#spiderfoot-output')?.dataset.runId;
      const statusPill = document.querySelector('#spiderfoot-status-pill');
      const meta = document.querySelector('#spiderfoot-meta');
      const stdoutEl = document.querySelector('#spiderfoot-stdout');
      const stderrEl = document.querySelector('#spiderfoot-stderr');
      const progressBar = document.querySelector('#spiderfoot-progress');
      const progressLabel = document.querySelector('#spiderfoot-progress-label');
      const finishedAlert = document.querySelector('#spiderfoot-finished');
      const stopButton = document.querySelector('#spiderfoot-stop');
      const bundleButtons = document.querySelectorAll('.spider-bundle');

      if (spiderPresetSelect && spiderModulesInput) {
        spiderPresetSelect.addEventListener('change', (evt) => {
          const option = evt.target.selectedOptions[0];
          const modules = option?.dataset.modules || '';
          if (option.value !== 'custom') {
            spiderModulesInput.value = modules;
          }
        });
      }

      if (bundleButtons && spiderModulesInput) {
        bundleButtons.forEach((btn) => {
          btn.addEventListener('click', () => {
            spiderModulesInput.value = btn.dataset.modules || '';
          });
        });
      }

      async function pollSpiderfoot() {
        if (!runId) return;
        try {
          const res = await fetch(`${window.location.origin}/spiderfoot/status/${runId}`);
          if (!res.ok) return;
          const data = await res.json();
          if (statusPill) {
            statusPill.textContent = data.running ? 'running' : 'finished';
            statusPill.className = `badge bg-${data.running ? 'secondary' : 'success'}`;
          }
          if (stopButton) {
            stopButton.classList.toggle('d-none', !data.running);
          }
          if (meta) {
            meta.textContent = data.running
              ? `Streaming stdout/stderr... started at ${data.started_at}.`
              : `SpiderFoot scan ${data.stopped_at ? 'stopped' : 'finished'}. Return code: ${data.returncode} · Started: ${data.started_at} · Finished: ${data.finished_at}`;
          }
          const pct = Number(data.progress || 0);
          if (progressBar) {
            progressBar.style.width = `${pct}%`;
            progressBar.setAttribute('aria-valuenow', pct.toString());
            progressBar.classList.toggle('progress-bar-animated', !!data.running);
            progressBar.classList.toggle('bg-success', !data.running);
          }
          if (progressLabel) {
            progressLabel.textContent = `${pct}%`;
          }
          if (finishedAlert && !data.running) {
            finishedAlert.classList.remove('d-none');
            finishedAlert.textContent = data.stopped_at ? 'SpiderFoot scan stopped.' : 'SpiderFoot scan finished.';
          }
          if (stdoutEl) stdoutEl.textContent = data.stdout || 'Awaiting output...';
          if (stderrEl) stderrEl.textContent = data.stderr || 'No stderr yet.';
          if (data.running) {
            setTimeout(pollSpiderfoot, 2500);
          }
        } catch (err) {
          console.error('Unable to refresh SpiderFoot output', err);
        }
      }

      if (stopButton) {
        stopButton.addEventListener('click', async () => {
          if (!runId) return;
          stopButton.disabled = true;
          stopButton.textContent = 'Stopping...';
          try {
            const res = await fetch(`${window.location.origin}/spiderfoot/stop/${runId}`, { method: 'POST' });
            if (!res.ok) {
              stopButton.textContent = 'Unable to stop';
              return;
            }
            await pollSpiderfoot();
            stopButton.textContent = 'Stopped';
          } catch (err) {
            console.error('Unable to stop SpiderFoot run', err);
            stopButton.textContent = 'Failed';
          }
        });
      }

      pollSpiderfoot();
    </script>
  {% else %}
    <script>
      const spiderPresetSelect = document.querySelector('#spiderPreset');
      const spiderModulesInput = document.querySelector('#spiderModules');
      if (spiderPresetSelect && spiderModulesInput) {
        spiderPresetSelect.addEventListener('change', (evt) => {
          const option = evt.target.selectedOptions[0];
          const modules = option?.dataset.modules || '';
          if (option.value !== 'custom') {
            spiderModulesInput.value = modules;
          }
        });
      }
    </script>
  {% endif %}
{% endblock %}

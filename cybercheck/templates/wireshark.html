{% extends "layout.html" %}
{% block body %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
  <div>
    <p class="text-uppercase text-muted small mb-1">Packet intelligence</p>
    <h1 class="h3 mb-2">In-house Wireshark</h1>
    <p class="text-muted mb-0">Upload PCAP files and review who talked to whom, which protocols fired, and even payload hex without leaving CyberCheck.</p>
  </div>
</div>

<div class="row g-4">
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h5 mb-3">PCAP analyzer</h2>
        <form method="POST" action="{{ url_for('wireshark_analyze') }}" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label" for="tokenInput">Engagement token</label>
            <input type="password" class="form-control" id="tokenInput" name="engagement_token" placeholder="Required" required>
            <div class="form-text">Same authorization token used for active scans.</div>
          </div>
          <div class="mb-3">
            <label class="form-label" for="userInput">Operator label</label>
            <input type="text" class="form-control" id="userInput" name="user" value="{{ form_state.user }}" maxlength="60">
          </div>
          <div class="mb-3">
            <label class="form-label" for="fileInput">PCAP file</label>
            <input class="form-control" type="file" id="fileInput" name="pcap_file" accept=".pcap,.pcapng,.cap,.pcap.gz" required>
            <div class="form-text">Drop exports from Wireshark/tcpdump to review on the server.</div>
          </div>
          <div class="form-check form-switch my-3">
            <input class="form-check-input" type="checkbox" role="switch" id="hexSwitch" name="include_hex" value="1" {% if form_state.include_hex %}checked{% endif %}>
            <label class="form-check-label" for="hexSwitch">Include hex dump for samples</label>
          </div>
          <div class="alert alert-warning small" role="alert">
            Uploaded files stay on the server and are removed right after parsing. Make sure PCAPs were captured within the engagement scope.
          </div>
          <button type="submit" class="btn btn-primary w-100">Analyze file</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-8">
    {% if analysis and analysis.report %}
      {% set report = analysis.report %}
      <div class="card shadow-sm mb-4 pcap-summary-card">
        <div class="card-body">
          <div class="pcap-summary-header">
            <div>
              <p class="pcap-eyebrow">Capture overview</p>
              <h2 class="h4 mb-1">{{ report.summary.source_label }}</h2>
              <p class="text-muted mb-0 small">{{ report.summary.filter or 'No capture filter supplied' }}</p>
            </div>
            <div class="pcap-summary-pill">
              <span>Packets analyzed</span>
              <strong>{{ report.summary.captured }}</strong>
            </div>
          </div>

          <div class="pcap-metric-grid">
            <div class="pcap-metric">
              <p class="pcap-metric-label">Data volume</p>
              <p class="pcap-metric-value">{{ (report.summary.bytes / 1024)|round(1) }} KB</p>
              <small class="text-muted">{{ report.summary.bytes }} bytes total</small>
            </div>
            <div class="pcap-metric">
              <p class="pcap-metric-label">Bandwidth</p>
              <p class="pcap-metric-value">{{ report.summary.bandwidth_bps }} bps</p>
              <small class="text-muted">Approximate throughput</small>
            </div>
            <div class="pcap-metric">
              <p class="pcap-metric-label">Window</p>
              <p class="pcap-metric-value">{{ report.summary.duration|round(2) }}s</p>
              <small class="text-muted">Capture duration</small>
            </div>
            <div class="pcap-metric">
              <p class="pcap-metric-label">Bandwidth / pkt</p>
              <p class="pcap-metric-value">
                {% if report.summary.captured %}
                  {{ (report.summary.bytes / report.summary.captured)|round(1) }} B
                {% else %}
                  0 B
                {% endif %}
              </p>
              <small class="text-muted">Average payload size</small>
            </div>
          </div>

          <div class="pcap-breakdown-grid">
            <div class="pcap-breakdown-card">
              <h3>Protocols</h3>
              <ul>
                {% for entry in report.protocols %}
                  <li>{{ entry.label }}</li>
                {% else %}
                  <li class="text-muted">No traffic observed.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="pcap-breakdown-card">
              <h3>Top talkers</h3>
              <ul>
                {% for entry in report.talkers %}
                  <li>{{ entry.label }}</li>
                {% else %}
                  <li class="text-muted">No data</li>
                {% endfor %}
              </ul>
            </div>
            <div class="pcap-breakdown-card">
              <h3>Top targets</h3>
              <ul>
                {% for entry in report.targets %}
                  <li>{{ entry.label }}</li>
                {% else %}
                  <li class="text-muted">No data</li>
                {% endfor %}
              </ul>
            </div>
            <div class="pcap-breakdown-card">
              <h3>Ports</h3>
              <ul>
                {% for entry in report.ports %}
                  <li>{{ entry.label }}</li>
                {% else %}
                  <li class="text-muted">No ports recorded.</li>
                {% endfor %}
              </ul>
            </div>
            <div class="pcap-breakdown-card">
              <h3>Flows</h3>
              <ul>
                {% for pair in report.pairs %}
                  <li>
                    <div class="small text-muted">{{ pair.src }} â†’ {{ pair.dst }}</div>
                  </li>
                {% else %}
                  <li class="text-muted">No flows available.</li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </div>
      </div>
      {% if report.filter_advice %}
        <div class="card shadow-sm mb-4 filter-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
              <div>
                <p class="text-uppercase text-muted small mb-1">Recommended filter</p>
                <h2 class="h5 mb-0">Focus on the riskiest traffic</h2>
              </div>
            </div>
            <pre class="result-pre filter-display mb-3">{{ report.filter_advice.display_filter }}</pre>
            <ul class="filter-reasons">
              {% for reason in report.filter_advice.reasons %}
                <li>{{ reason }}</li>
              {% else %}
                <li>No additional rationale supplied.</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
            <div>
              <h2 class="h5 mb-0">Sample packets</h2>
              <small class="text-muted">Showing up to {{ report.samples|length }} packets</small>
            </div>
            {% if analysis.run_id %}
              <div class="btn-group">
                <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('wireshark_full', run_id=analysis.run_id) }}" target="_blank" rel="noopener">Open full capture</a>
                <a class="btn btn-outline-primary btn-sm" href="{{ url_for('wireshark_cleanup', run_id=analysis.run_id) }}" target="_blank" rel="noopener">Clean up noise</a>
              </div>
            {% endif %}
          </div>
          <div class="table-responsive">
            <table class="table table-sm align-middle sample-packets-table">
              <thead>
                <tr>
                  <th scope="col">Time</th>
                  <th scope="col">Source</th>
                  <th scope="col">Destination</th>
                  <th scope="col">Proto</th>
                  <th scope="col">Len</th>
                  <th scope="col">Info</th>
                </tr>
              </thead>
              <tbody>
                {% for pkt in report.samples %}
                  <tr>
                    <td class="text-nowrap">{{ pkt.timestamp }}</td>
                    <td class="font-monospace">{{ pkt.src }}</td>
                    <td class="font-monospace">{{ pkt.dst }}</td>
                    <td>{{ pkt.proto }}</td>
                    <td>{{ pkt.length }}</td>
                    <td><small class="text-muted">{{ pkt.info }}</small></td>
                  </tr>
                  {% if pkt.hex %}
                    <tr>
                      <td colspan="6"><pre class="result-pre small mb-0">{{ pkt.hex }}</pre></td>
                    </tr>
                  {% endif %}
                {% else %}
                  <tr>
                    <td colspan="6" class="text-muted">No packets captured.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="card shadow-sm mt-4">
        <div class="card-body">
          <h2 class="h6 text-uppercase text-muted">Raw transcript</h2>
          <pre class="result-pre small mb-0">{{ analysis.stdout or 'No stdout logged.' }}</pre>
          {% if analysis.stderr %}
            <div class="alert alert-danger small mt-3 mb-0">{{ analysis.stderr }}</div>
          {% endif %}
        </div>
      </div>
    {% elif analysis %}
      <div class="alert alert-danger">Analysis failed: {{ analysis.stderr or 'Unknown error' }}</div>
    {% else %}
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h2 class="h5">Why upload instead of live capture?</h2>
          <ul class="mb-0">
            <li>Share captures with the rest of the team without shipping gigantic PCAPs around.</li>
            <li>Instant stats on protocols, top talkers, and hot ports to triage noisy neighbors.</li>
            <li>Optional hex dumps mimic Wireshark's packet bytes pane for quick payload checks.</li>
            <li>Structured output is logged just like other CyberCheck runs for repeatability.</li>
          </ul>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

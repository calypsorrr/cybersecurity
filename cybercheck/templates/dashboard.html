{% extends "layout.html" %}
{% block body %}

<div class="page-header">
  <div>
    <h1 class="display-6">Operations dashboard</h1>
    <p class="page-subtitle">Stay aligned with your authorized environment. Review telemetry from the last 50 executions and confirm the health of each monitored target before the next engagement step.</p>
  </div>
  <div class="d-flex flex-column align-items-lg-end gap-2">
    <div class="metric-card p-3">
      <span class="metric-label">Last completed run</span>
      <span class="metric-value" style="font-size:1.25rem;">{{ overview.last_finished }}</span>
      <span class="metric-subtext">Data pulled directly from the engagement log</span>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Runs analysed</span>
      <span class="metric-value">{{ overview.total_runs }}</span>
      <span class="metric-subtext">Most recent entries stored on disk</span>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Average duration</span>
      <span class="metric-value">{{ '%.1f'|format(overview.avg_duration) }}s</span>
      <span class="metric-subtext">Across runs with clear start and finish times</span>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Tool coverage</span>
      <span class="metric-value">{{ tool_totals|length }}</span>
      <span class="metric-subtext">Unique tools seen in the latest results</span>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Open findings</span>
      <span class="metric-value">{{ coverage.open_findings }}</span>
      <span class="metric-subtext">Across mapped assets and controls</span>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12 col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold">Tracked endpoints</div>
      <div class="card-body">
        {% if target_cards %}
          <div class="row g-3">
            {% for card in target_cards %}
              <div class="col-12 col-md-6">
                <div class="status-card status-{{ card.status_key }} h-100">
                  <span class="status-label">{{ card.tool_display }}</span>
                  <div class="status-headline">{{ card.target }}</div>
                  <div class="status-meta">{{ card.status_label }}</div>
                  <div class="status-meta">Operator: {{ card.operator }}</div>
                  <div class="status-meta">Last seen: {{ card.finished_display }}</div>
                  <div class="status-meta">{{ card.status_hint }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">No runs logged yet. Execute a quick scan to populate this view.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold">Tool utilisation</div>
      <div class="card-body">
        {% if tool_totals %}
          <div class="vstack gap-2">
            {% for tool in tool_totals %}
              <div class="timeline-item">
                <div class="timeline-main">
                  <div class="fw-semibold text-uppercase small text-muted">{{ tool.label }}</div>
                  <div class="fs-5 fw-bold">{{ tool.count }} run{{ '' if tool.count == 1 else 's' }}</div>
                </div>
                <span class="timeline-tag status-healthy">In rotation</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">No tool data captured yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-header fw-semibold">Recent activity</div>
  <div class="card-body">
    {% if timeline %}
      <ul class="timeline-list">
        {% for item in timeline %}
          <li class="timeline-item">
            <div class="timeline-main">
              <div class="fw-semibold">{{ item.tool_display }} → {{ item.target }}</div>
              <div class="text-muted small">Operator: {{ item.operator }} · {{ item.finished_display }}</div>
            </div>
            <span class="timeline-tag status-{{ item.status_key }}">{{ item.status_key.replace('_', ' ')|title }}</span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted mb-0">Once you run a scan it will appear here with timestamps and operator details.</p>
    {% endif %}
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-12 col-xxl-7">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-semibold">Asset inventory &amp; control mapping</span>
        <span class="badge text-bg-primary">ATT&amp;CK coverage</span>
      </div>
      <div class="card-body">
        {% if coverage.assets %}
          <div class="table-responsive">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th>Asset</th>
                  <th>Owner</th>
                  <th>Controls</th>
                  <th>ATT&amp;CK tactics</th>
                  <th>Open findings</th>
                </tr>
              </thead>
              <tbody>
                {% for asset in coverage.assets %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ asset.name }}</div>
                      <div class="small text-muted">{{ asset.category }} · {{ asset.scope }}</div>
                    </td>
                    <td>{{ asset.owner }}<div class="small text-muted">{{ asset.business_unit }}</div></td>
                    <td>{{ asset.control_total or 0 }}</td>
                    <td>{{ asset.tactics or '—' }}</td>
                    <td>{{ asset.open_findings or 0 }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">No assets registered. Add scope to enable risk-aware dashboards.</p>
        {% endif %}
      </div>
    </div>
  </div>
  <div class="col-12 col-xxl-5">
    <div class="card shadow-sm h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <span class="fw-semibold">Findings lifecycle</span>
        <span class="badge text-bg-warning text-dark">Remediation</span>
      </div>
      <div class="card-body">
        {% if findings %}
          <div class="vstack gap-3">
            {% for finding in findings %}
              {% set status_key = (finding.status or 'open').lower() %}
              {% if 'progress' in status_key %}
                {% set badge_class = 'status-attention' %}
              {% elif status_key == 'verified' %}
                {% set badge_class = 'status-healthy' %}
              {% elif status_key == 'open' %}
                {% set badge_class = 'status-error' %}
              {% else %}
                {% set badge_class = 'status-unknown' %}
              {% endif %}
              <div class="timeline-item">
                <div class="timeline-main">
                  <div class="fw-semibold">{{ finding.title }}</div>
                  <div class="text-muted small">{{ finding.asset_name or 'Unmapped asset' }} · {{ finding.control_name or 'Control not tagged' }}</div>
                  <div class="small">Ticket: {{ finding.ticket or 'Not filed' }}</div>
                </div>
                <div class="d-flex flex-column align-items-end gap-1">
                  <span class="timeline-tag {{ badge_class }}">{{ finding.status or 'Open' }}</span>
                  <span class="badge text-bg-secondary">{{ finding.severity or 'Info' }}</span>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">No findings recorded yet. Run scans or import tickets to populate the lifecycle.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}

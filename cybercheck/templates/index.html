{% extends "layout.html" %}
{% block body %}

<div class="hero-banner mb-4">
  <div class="hero-grid">
    <div>
      <span class="hero-badge">Unified security cockpit</span>
      <h1 class="hero-title">Command offensive checks and defensive telemetry from one console.</h1>
      <p class="hero-text">Run zero-trust friendly scans, capture every artifact, and jump straight into remediation workflows without leaving the browser.</p>

      <div class="pill-row">
        <span class="pill">Nmap + Nikto + Scapy</span>
        <span class="pill">DAST / API hardening</span>
        <span class="pill">Secrets &amp; supply chain</span>
        <span class="pill">ATT&amp;CK mapped assets</span>
      </div>

      <div class="hero-actions">
        <a class="btn btn-light" href="#active-scan">Start active scan</a>
        <a class="btn btn-outline-light" href="{{ url_for('dashboard') }}">Open operations dashboard</a>
        <small>Everything is logged, auditable, and exportable.</small>
      </div>
    </div>

    <div class="hero-panel">
      <h3 class="text-uppercase text-muted">Live posture</h3>
      <div class="hero-metric">
        <strong>{{ metrics.active_runs }}</strong>
        <span>active tooling in the last window</span>
      </div>
      <div class="hero-metric">
        <strong>{{ metrics.asset_count }}</strong>
        <span>registered assets with owners</span>
      </div>
      <ul class="mini-list small">
        <li>Last scan closed: {{ metrics.last_active_finished }}</li>
        <li>Open findings: {{ metrics.open_findings }} · Control gaps: {{ metrics.control_gaps }}</li>
        <li>API surfaces: <code>/api/runs</code> and <code>/api/compliance</code></li>
      </ul>
    </div>
  </div>
</div>

<div class="insights-grid mb-4">
  <div class="metric-card">
    <span class="metric-label">Runs logged</span>
    <span class="metric-value">{{ metrics.total_runs }}</span>
    <span class="metric-subtext">Local SQLite engagement history for every scan.</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Open findings</span>
    <span class="metric-value">{{ metrics.open_findings }}</span>
    <span class="metric-subtext">Triaged issues ready for ticket handoff.</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Control gaps</span>
    <span class="metric-value">{{ metrics.control_gaps }}</span>
    <span class="metric-subtext">Controls missing asset mapping.</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">API endpoint</span>
    <span class="metric-value" style="font-size:1.4rem;">/api/runs</span>
    <span class="metric-subtext">Pull structured JSON for downstream tooling.</span>
  </div>
  <div class="metric-card">
    <span class="metric-label">Compliance export</span>
    <span class="metric-value" style="font-size:1.2rem;">/api/compliance</span>
    <span class="metric-subtext">Controls + findings enriched with CVE intel.</span>
  </div>
  <div class="metric-card">
    <div class="d-flex align-items-center justify-content-between">
      <span class="metric-label">Operator hygiene</span>
      <span class="metric-chip">Live</span>
    </div>
    <span class="metric-value" style="font-size:1.55rem;">{{ metrics.asset_count }} assets</span>
    <span class="metric-subtext">Verified owners, SLAs, and ATT&amp;CK mapping by target.</span>
  </div>
</div>

<div class="row g-4">
  <!-- Primary column -->
  <div class="col-12 col-xxl-7">

    <!-- One-click sweep (surfaced first) -->
    <div class="card shadow-sm" id="standard-sweep">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <span class="fw-semibold d-block">One-click standard sweep</span>
          <small class="text-muted">Runs Nmap (standard), Nikto, and Scapy sequentially, saving artifacts.</small>
        </div>
        <span class="badge text-bg-primary">Bundle</span>
      </div>
      <div class="card-body">
        <form method="post" action="/run_standard_suite" class="vstack gap-3" novalidate>
          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <label class="form-label" for="suiteTarget">Target</label>
              <input id="suiteTarget" class="form-control" name="target" placeholder="host or URL" autocomplete="off" required>
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="suiteUser">Operator</label>
              <input id="suiteUser" class="form-control" name="user" placeholder="Your name or initials" autocomplete="off">
            </div>
          </div>

          <div class="row g-3 align-items-end">
            <div class="col-12 col-lg-6">
              <label class="form-label" for="suiteInterface">Capture interface (optional)</label>
              <input id="suiteInterface" class="form-control" name="capture_interface" placeholder="eth0" autocomplete="off">
              <div class="form-text">If set, traffic is captured to a PCAP while the sweep runs.</div>
            </div>
            <div class="col-12 col-lg-6">
              <div class="form-check h-100 d-flex align-items-center gap-2">
                <input class="form-check-input" type="checkbox" value="1" id="suiteCapture" name="capture_traffic" checked>
                <label class="form-check-label" for="suiteCapture">
                  Capture traffic to PCAP
                </label>
              </div>
            </div>
          </div>

          <div>
            <label class="form-label" for="suiteToken">Engagement token</label>
            <input id="suiteToken" class="form-control" name="engagement_token" placeholder="ENGAGEMENT TOKEN (required)" autocomplete="off" required>
            <div class="form-text">Required to run the active Nmap/Nikto/Scapy bundle.</div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary">Run standard sweep</button>
            <span class="text-muted small align-self-center">Results saved to <code>logs</code> (txt) and optional PCAP.</span>
          </div>
        </form>
      </div>
    </div>

    <!-- Active -->
    <div class="card shadow-sm mt-4" id="active-scan">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <span class="fw-semibold d-block">Active reconnaissance</span>
          <small class="text-muted">Nmap, Scapy and Nikto — requires engagement token</small>
        </div>
        <span class="badge text-bg-danger">Authorized targets only</span>
      </div>
      <div class="card-body">
        <form method="post" action="/run_active" class="vstack gap-3" novalidate>

          <div class="alert alert-warning mb-0" role="alert">
            <div class="fw-semibold">Always verify scope before running active scans.</div>
            <div class="small mb-0">Use the dashboard shortcut on the left to confirm the environment you are targeting.</div>
          </div>

          <hr class="text-muted">

          <div>
            <label class="form-label" for="activeTool">Tool</label>
            <select name="tool" id="activeTool" class="form-select" required>
              <option value="nmap">nmap (port + service discovery)</option>
              <option value="nikto">nikto (HTTP vulns)</option>
              <option value="scapy">scapy (ICMP ping)</option>
            </select>
          </div>

          <div class="row g-3">
            <div class="col-12 col-lg-8">
              <label class="form-label" for="activeTarget">Target</label>
              <input id="activeTarget" class="form-control" name="target" placeholder="target host or URL" autocomplete="off" required>
            </div>
            <div class="col-12 col-lg-4">
              <label class="form-label" for="activeUser">Operator</label>
              <input id="activeUser" class="form-control" name="user" placeholder="Your name or initials" autocomplete="off">
            </div>
          </div>

          <!-- nmap-only options -->
          <div id="nmapOptions" class="vstack gap-3 d-none">
            <div>
              <label class="form-label" for="nmapProfile">Nmap profile</label>
              <select id="nmapProfile" name="nmap_profile" class="form-select">
                <option value="">(default)</option>
                {% for p in nmap_profiles %}
                  <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
              <div class="form-text">Preset scan patterns (e.g., <code>standard</code>, <code>top-ports</code>, <code>vuln-scan</code>).</div>
            </div>

            <div>
              <label class="form-label" for="nmapExtra">Extra args (optional)</label>
              <input id="nmapExtra" class="form-control" name="extra_args" placeholder="Additional nmap args, space-separated">
            </div>
          </div>

          <!-- scapy-only options -->
          <div id="scapyOptions" class="vstack gap-3 d-none">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label" for="scapyCount">ICMP probes</label>
                <input id="scapyCount" class="form-control" name="scapy_count" placeholder="Number of probes (default 4)" inputmode="numeric" pattern="\d*">
                <div class="form-text">Sends ICMP echo requests to the target host.</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="scapyTimeout">Timeout (seconds)</label>
                <input id="scapyTimeout" class="form-control" name="scapy_timeout" placeholder="Reply timeout per probe (default 2.0)" inputmode="decimal">
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="scapyInterval">Interval (seconds)</label>
                <input id="scapyInterval" class="form-control" name="scapy_interval" placeholder="Delay between probes (default 1.0)" inputmode="decimal">
                <div class="form-text">Set to 0 for back-to-back packets.</div>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label" for="scapyPayloadSize">Payload size (bytes)</label>
                <input id="scapyPayloadSize" class="form-control" name="scapy_payload_size" placeholder="Generated payload length (default 32)" inputmode="numeric" pattern="\d*">
                <div class="form-text">Used when no custom payload is provided.</div>
              </div>
            </div>
          </div>

          <div>
            <label class="form-label" for="engToken">Engagement token</label>
            <input id="engToken" class="form-control" name="engagement_token" placeholder="ENGAGEMENT TOKEN (required)" autocomplete="off" required>
            <div class="form-text">Set <code>ENGAGEMENT_TOKEN</code> in your environment and paste it here for each run.</div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-danger">Run active scan</button>
            <span class="text-muted small align-self-center">Results appear immediately and in the dashboard history.</span>
          </div>
        </form>
      </div>
    </div>

    <!-- Non-intrusive -->
    <div class="card shadow-sm mt-4">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <span class="fw-semibold d-block">Local assurance checks</span>
          <small class="text-muted">Safe to run against your own source tree</small>
        </div>
        <span class="badge text-bg-success">Non-intrusive</span>
      </div>
      <div class="card-body">
        <form method="post" action="/run_non_intrusive" class="vstack gap-3" novalidate>
          <div>
            <label class="form-label" for="niTool">Tool</label>
            <select id="niTool" name="tool" class="form-select" required>
              <option value="bandit">Bandit (static Python)</option>
              <option value="pip-audit">pip-audit (dependencies)</option>
            </select>
          </div>

          <div>
            <label class="form-label" for="banditTarget">Target</label>
            <select name="target" id="banditTarget" class="form-select">
              <option value="" selected disabled>(choose from project …)</option>
              {% for p in scan_presets %}
                <option value="{{ p }}">{{ p }}</option>
              {% endfor %}
              <option value="__custom__">Custom path… (type below)</option>
            </select>
            <div class="form-text">Pick a path from the list or choose <strong>Custom path…</strong> and type it below.</div>
          </div>

          <div id="customPathWrap" class="d-none">
            <label class="form-label" for="customPath">Custom path</label>
            <input id="customPath" class="form-control" name="target_custom" placeholder="./ or absolute path" autocomplete="off">
          </div>

          <div>
            <label class="form-label" for="banditExclude">Exclude paths (Bandit)</label>
            <input id="banditExclude" class="form-control" name="bandit_exclude" placeholder="comma-separated, e.g. cybercheck/app.py,cybercheck/config.py">
            <div class="form-text">Maps to <code>bandit -x</code>. Relative paths resolved from the app folder.</div>
          </div>

          <div>
            <label class="form-label" for="banditSkip">Skip rules (Bandit)</label>
            <input id="banditSkip" class="form-control" name="bandit_skip" placeholder="comma-separated rule IDs, e.g. B404,B603">
            <div class="form-text">Maps to <code>bandit -s</code>. Only for Bandit runs.</div>
          </div>

          <div>
            <label class="form-label" for="niUser">Operator</label>
            <input id="niUser" class="form-control" name="user" placeholder="Your name or initials" autocomplete="off">
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary">Run</button>
            <span class="text-muted small align-self-center">Results appear below and in the dashboard history.</span>
          </div>
        </form>
      </div>
    </div>

    <!-- App/API, secrets, and supply-chain coverage -->
    <div class="card shadow-sm mt-4">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <span class="fw-semibold d-block">App/API + supply chain suite</span>
          <small class="text-muted">ZAP automation, secrets scanning, containers, IaC, and memory forensics</small>
        </div>
        <span class="badge text-bg-primary">Alerting ready</span>
      </div>
      <div class="card-body">
        <form method="post" action="/run_appsec_suite" class="vstack gap-3" novalidate>
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <label class="form-label" for="suiteTool">Tooling</label>
              <select id="suiteTool" name="tool" class="form-select" required>
                <option value="zap-baseline">ZAP baseline (DAST)</option>
                <option value="zap-api">ZAP API (OpenAPI/Swagger)</option>
                <option value="zap-full">ZAP full (ajax spider + policy)</option>
                <option value="gitleaks">Gitleaks (secrets)</option>
                <option value="trufflehog">TruffleHog (secrets)</option>
                <option value="trivy">Trivy (container/IaC)</option>
                <option value="grype">Grype (SBOM vuln)</option>
                <option value="checkov">Checkov (IaC posture)</option>
                <option value="volatility">Volatility (memory)</option>
              </select>
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label" for="suiteTarget">Target</label>
              <input id="suiteTarget" class="form-control" name="target" placeholder="URL, image:tag, or file" required>
              <div class="form-text">Targets can be URLs, container images, repos, or memory dumps.</div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <label class="form-label" for="apiDefinition">API definition (optional)</label>
              <input id="apiDefinition" class="form-control" name="api_definition" placeholder="OpenAPI URL or file">
              <div class="form-text">Used by ZAP API mode; ignored otherwise.</div>
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="zapPolicy">ZAP policy (optional)</label>
              <input id="zapPolicy" class="form-control" name="zap_policy" placeholder="e.g., OWASP-C">
            </div>
            <div class="col-12 col-lg-3">
              <label class="form-label" for="volPlugin">Volatility plugin</label>
              <input id="volPlugin" class="form-control" name="vol_plugin" value="pslist" placeholder="pslist, netscan, ...">
            </div>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="ajaxSpider" name="ajax_spider" value="true">
            <label class="form-check-label" for="ajaxSpider">Enable AJAX spider (JS-heavy apps)</label>
          </div>

          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <label class="form-label" for="suiteUser">Operator</label>
              <input id="suiteUser" class="form-control" name="user" placeholder="Your name or initials">
            </div>
            <div class="col-12 col-lg-6">
              <label class="form-label" for="suiteToken">Engagement token (required for active scans)</label>
              <input id="suiteToken" class="form-control" name="engagement_token" placeholder="ENGAGEMENT TOKEN">
              <div class="form-text">Used when running ZAP/Trivy/Grype/Checkov against live targets.</div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-primary">Run suite task</button>
            <span class="text-muted small align-self-center">Outputs are log-friendly for SIEM forwarding.</span>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- Secondary column -->
  <div class="col-12 col-xxl-5">
    <div class="card shadow-sm">
      <div class="card-header fw-semibold">Recent runs</div>
      <div class="card-body">
        {% if runs %}
          <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">Tool</th>
                  <th scope="col">Target</th>
                  <th scope="col">Started (UTC)</th>
                </tr>
              </thead>
              <tbody>
              {% for r in runs %}
                <tr>
                  <td class="text-muted">{{ r['id'] }}</td>
                  <td><span class="badge text-bg-secondary">{{ r['tool'] }}</span></td>
                  <td class="text-truncate" style="max-width: 220px;" title="{{ r['target'] }}">{{ r['target'] }}</td>
                  <td class="text-nowrap">{{ r['started_at'] }}</td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-muted mb-0">No runs recorded yet.</p>
        {% endif %}
      </div>
    </div>

    <div class="card shadow-sm mt-4">
      <div class="card-header fw-semibold">API</div>
      <div class="card-body">
        <p class="mb-1">GET <code>/api/runs</code> — returns last runs as JSON.</p>
        <p class="mb-0">GET <code>/api/compliance</code> — controls, mappings, and CVE-enriched findings for SIEM/BI.</p>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div>
      <span class="fw-semibold d-block">Asset inventory &amp; control mapping</span>
      <small class="text-muted">Tie each target to owners, SLAs, and ATT&amp;CK tactics before you launch another scan.</small>
    </div>
    <span class="badge text-bg-primary">Scope register</span>
  </div>
  <div class="card-body">
    {% if assets %}
      <div class="table-responsive">
        <table class="table align-middle mb-0">
          <thead>
            <tr>
              <th>Asset</th>
              <th>Owner / BU</th>
              <th>ATT&amp;CK coverage</th>
              <th>Controls</th>
              <th>Open / Verified</th>
              <th>SLA</th>
            </tr>
          </thead>
          <tbody>
            {% for asset in assets %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ asset.name }}</div>
                  <div class="small text-muted">{{ asset.category }} · {{ asset.scope }}</div>
                </td>
                <td>
                  <div class="fw-semibold">{{ asset.owner }}</div>
                  <div class="small text-muted">{{ asset.business_unit }}</div>
                </td>
                <td>{{ asset.tactics or '—' }}</td>
                <td>{{ asset.control_total or 0 }}</td>
                <td>{{ asset.open_findings or 0 }} / {{ asset.verified_findings or 0 }}</td>
                <td>{{ asset.sla_days }} day SLA</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="text-muted mb-0">Add an asset to start mapping scans to owners and controls.</p>
    {% endif %}
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div>
      <span class="fw-semibold d-block">Findings workflow</span>
      <small class="text-muted">Track severity, owners, and tickets so remediation doesn&#39;t vanish when the tab closes.</small>
    </div>
    <span class="badge text-bg-warning text-dark">Remediation</span>
  </div>
  <div class="card-body">
    {% if findings %}
      <div class="vstack gap-3">
        {% for finding in findings %}
          {% set status_key = (finding.status or 'open').lower() %}
          {% if 'progress' in status_key %}
            {% set badge_class = 'status-attention' %}
          {% elif status_key == 'verified' %}
            {% set badge_class = 'status-healthy' %}
          {% elif status_key == 'open' %}
            {% set badge_class = 'status-error' %}
          {% else %}
            {% set badge_class = 'status-unknown' %}
          {% endif %}
          <div class="timeline-item">
            <div class="timeline-main">
              <div class="fw-semibold">{{ finding.title }}</div>
              <div class="text-muted small">{{ finding.asset_name or 'Unmapped asset' }} · {{ finding.control_name or 'Control not tagged' }}</div>
              <div class="small">Ticket: {{ finding.ticket or 'Not filed' }}</div>
            </div>
            <div class="d-flex flex-column align-items-end gap-1">
              <span class="timeline-tag {{ badge_class }}">{{ finding.status or 'Open' }}</span>
              <span class="badge text-bg-secondary">{{ finding.severity or 'Info' }}</span>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="text-muted mb-0">Capture findings to assign owners and exportable tickets.</p>
    {% endif %}
  </div>
</div>

<!-- Page-specific JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Enhance the Bandit target select if Choices is available
  if (window.initChoices) { window.initChoices('#banditTarget'); }

  // Custom path toggle
  const sel = document.getElementById('banditTarget');
  const customWrap = document.getElementById('customPathWrap');
  const toggleCustom = () => customWrap.classList.toggle('d-none', sel.value !== '__custom__');
  sel.addEventListener('change', toggleCustom);
  toggleCustom();

  // Active tool option groups
  const activeTool   = document.getElementById('activeTool');
  const nmapOptions  = document.getElementById('nmapOptions');
  const scapyOptions = document.getElementById('scapyOptions');

  const toggleActiveOptions = () => {
    const tool = activeTool.value;
    nmapOptions.classList.toggle('d-none', tool !== 'nmap');
    scapyOptions.classList.toggle('d-none', tool !== 'scapy');
  };
  activeTool.addEventListener('change', toggleActiveOptions);
  toggleActiveOptions();

  // Disable interface field when capture is off for the sweep bundle
  const suiteCapture   = document.getElementById('suiteCapture');
  const suiteInterface = document.getElementById('suiteInterface');
  const toggleCaptureInterface = () => {
    const enabled = suiteCapture.checked;
    suiteInterface.toggleAttribute('disabled', !enabled);
  };
  suiteCapture.addEventListener('change', toggleCaptureInterface);
  toggleCaptureInterface();
});
</script>

{% endblock %}

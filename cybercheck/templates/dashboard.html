{% extends "layout.html" %}
{% block body %}

<div class="page-header">
  <div>
    <h1 class="display-6">Operations dashboard</h1>
    <p class="page-subtitle">Stay aligned with your authorized environment. Review telemetry from the last 50 executions and confirm the health of each monitored target before the next engagement step.</p>
  </div>
  <div class="d-flex flex-column align-items-lg-end gap-2">
    <div class="metric-card p-3">
      <span class="metric-label">Last completed run</span>
      <span class="metric-value" style="font-size:1.25rem;">{{ overview.last_finished }}</span>
      <span class="metric-subtext">Data pulled directly from the engagement log</span>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Runs analysed</span>
      <span class="metric-value">{{ overview.total_runs }}</span>
      <span class="metric-subtext">Most recent entries stored on disk</span>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Average duration</span>
      <span class="metric-value">{{ '%.1f'|format(overview.avg_duration) }}s</span>
      <span class="metric-subtext">Across runs with clear start and finish times</span>
    </div>
  </div>
  <div class="col-12 col-md-4">
    <div class="metric-card">
      <span class="metric-label">Tool coverage</span>
      <span class="metric-value">{{ tool_totals|length }}</span>
      <span class="metric-subtext">Unique tools seen in the latest results</span>
    </div>
  </div>
</div>

<div class="row g-4">
  <div class="col-12 col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold">Tracked endpoints</div>
      <div class="card-body">
        {% if target_cards %}
          <div class="row g-3">
            {% for card in target_cards %}
              <div class="col-12 col-md-6">
                <div class="status-card status-{{ card.status_key }} h-100">
                  <span class="status-label">{{ card.tool_display }}</span>
                  <div class="status-headline">{{ card.target }}</div>
                  <div class="status-meta">{{ card.status_label }}</div>
                  <div class="status-meta">Operator: {{ card.operator }}</div>
                  <div class="status-meta">Last seen: {{ card.finished_display }}</div>
                  <div class="status-meta">{{ card.status_hint }}</div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">No runs logged yet. Execute a quick scan to populate this view.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-header fw-semibold">Tool utilisation</div>
      <div class="card-body">
        {% if tool_totals %}
          <div class="vstack gap-2">
            {% for tool in tool_totals %}
              <div class="timeline-item">
                <div class="timeline-main">
                  <div class="fw-semibold text-uppercase small text-muted">{{ tool.label }}</div>
                  <div class="fs-5 fw-bold">{{ tool.count }} run{{ '' if tool.count == 1 else 's' }}</div>
                </div>
                <span class="timeline-tag status-healthy">In rotation</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted mb-0">No tool data captured yet.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mt-4">
  <div class="card-header fw-semibold">Recent activity</div>
  <div class="card-body">
    {% if timeline %}
      <ul class="timeline-list">
        {% for item in timeline %}
          <li class="timeline-item">
            <div class="timeline-main">
              <div class="fw-semibold">{{ item.tool_display }} → {{ item.target }}</div>
              <div class="text-muted small">Operator: {{ item.operator }} · {{ item.finished_display }}</div>
            </div>
            <span class="timeline-tag status-{{ item.status_key }}">{{ item.status_key.replace('_', ' ')|title }}</span>
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-muted mb-0">Once you run a scan it will appear here with timestamps and operator details.</p>
    {% endif %}
  </div>
</div>

{% endblock %}

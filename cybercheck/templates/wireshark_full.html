{% extends "layout.html" %}
{% block body %}
<div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-4">
  <div>
    <p class="text-uppercase text-muted small mb-1">Packet intelligence</p>
    <h1 class="h3 mb-2">Full PCAP view</h1>
    <p class="text-muted mb-0">
      Showing {{ samples|length }} packet{{ 's' if samples|length != 1 else '' }} captured from
      {{ summary.source_label or 'uploaded file' }}.
    </p>
  </div>
  <div class="d-flex flex-wrap gap-2">
    <a class="btn btn-outline-secondary" href="{{ url_for('wireshark_console') }}">← Back to uploader</a>
    <a class="btn btn-outline-primary" href="{{ url_for('wireshark_cleanup', run_id=run_id) }}" target="_blank" rel="noopener">Clean up noise</a>
  </div>
</div>

{% if report %}
  <div class="card shadow-sm mb-4 pcap-summary-card">
    <div class="card-body">
      <div class="pcap-summary-header">
        <div>
          <p class="pcap-eyebrow">Capture overview</p>
          <h2 class="h4 mb-1">{{ summary.source_label or 'PCAP upload' }}</h2>
          <p class="text-muted mb-0 small">{{ summary.filter or 'No capture filter supplied' }}</p>
        </div>
        <div class="pcap-summary-pill">
          <span>Packets analyzed</span>
          <strong>{{ summary.captured }}</strong>
        </div>
      </div>

      <div class="pcap-metric-grid">
        <div class="pcap-metric">
          <p class="pcap-metric-label">Data volume</p>
          <p class="pcap-metric-value">{{ (summary.bytes / 1024)|round(1) }} KB</p>
          <small class="text-muted">{{ summary.bytes }} bytes total</small>
        </div>
        <div class="pcap-metric">
          <p class="pcap-metric-label">Bandwidth</p>
          <p class="pcap-metric-value">{{ summary.bandwidth_bps }} bps</p>
          <small class="text-muted">Approximate throughput</small>
        </div>
        <div class="pcap-metric">
          <p class="pcap-metric-label">Window</p>
          <p class="pcap-metric-value">{{ summary.duration|round(2) }}s</p>
          <small class="text-muted">Capture duration</small>
        </div>
        <div class="pcap-metric">
          <p class="pcap-metric-label">Bandwidth / pkt</p>
          <p class="pcap-metric-value">
            {% if summary.captured %}
              {{ (summary.bytes / summary.captured)|round(1) }} B
            {% else %}
              0 B
            {% endif %}
          </p>
          <small class="text-muted">Average payload size</small>
        </div>
      </div>

      <div class="pcap-breakdown-grid">
        <div class="pcap-breakdown-card">
          <h3>Protocols</h3>
          <ul>
            {% for entry in report.protocols %}
              <li>{{ entry.label }}</li>
            {% else %}
              <li class="text-muted">No traffic observed.</li>
            {% endfor %}
          </ul>
        </div>
        <div class="pcap-breakdown-card">
          <h3>Top talkers</h3>
          <ul>
            {% for entry in report.talkers %}
              <li>{{ entry.label }}</li>
            {% else %}
              <li class="text-muted">No data</li>
            {% endfor %}
          </ul>
        </div>
        <div class="pcap-breakdown-card">
          <h3>Top targets</h3>
          <ul>
            {% for entry in report.targets %}
              <li>{{ entry.label }}</li>
            {% else %}
              <li class="text-muted">No data</li>
            {% endfor %}
          </ul>
        </div>
        <div class="pcap-breakdown-card">
          <h3>Ports</h3>
          <ul>
            {% for entry in report.ports %}
              <li>{{ entry.label }}</li>
            {% else %}
              <li class="text-muted">No ports recorded.</li>
            {% endfor %}
          </ul>
        </div>
        <div class="pcap-breakdown-card">
          <h3>Flows</h3>
          <ul>
            {% for pair in report.pairs %}
              <li>
                <div class="small text-muted">{{ pair.src }} → {{ pair.dst }}</div>
              </li>
            {% else %}
              <li class="text-muted">No flows available.</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>

  {% if report.filter_advice %}
    <div class="card shadow-sm mb-4 filter-card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-3">
          <div>
            <p class="text-uppercase text-muted small mb-1">Recommended filter</p>
            <h2 class="h5 mb-0">Focus on the riskiest traffic</h2>
          </div>
        </div>
        <pre class="result-pre filter-display mb-3">{{ report.filter_advice.display_filter }}</pre>
        <ul class="filter-reasons">
          {% for reason in report.filter_advice.reasons %}
            <li>{{ reason }}</li>
          {% else %}
            <li>No additional rationale supplied.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  {% endif %}

  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
        <div>
          <h2 class="h5 mb-0">All packets</h2>
          <small class="text-muted">Showing {{ samples|length }} rows</small>
        </div>
        <span class="badge text-bg-secondary">Full capture</span>
      </div>
      <div class="table-responsive">
        <table class="table table-sm align-middle sample-packets-table">
          <thead>
            <tr>
              <th scope="col">Time</th>
              <th scope="col">Source</th>
              <th scope="col">Destination</th>
              <th scope="col">Proto</th>
              <th scope="col">Len</th>
              <th scope="col">Info</th>
            </tr>
          </thead>
          <tbody>
            {% for pkt in samples %}
              <tr>
                <td class="text-nowrap">{{ pkt.timestamp }}</td>
                <td class="font-monospace">{{ pkt.src }}</td>
                <td class="font-monospace">{{ pkt.dst }}</td>
                <td>{{ pkt.proto }}</td>
                <td>{{ pkt.length }}</td>
                <td><small class="text-muted">{{ pkt.info }}</small></td>
              </tr>
              {% if pkt.hex %}
                <tr>
                  <td colspan="6"><pre class="result-pre small mb-0">{{ pkt.hex }}</pre></td>
                </tr>
              {% endif %}
            {% else %}
              <tr>
                <td colspan="6" class="text-muted">No packets captured.</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mt-4">
    <div class="card-body">
      <h2 class="h6 text-uppercase text-muted">Raw transcript</h2>
      <pre class="result-pre small mb-0">{{ analysis.stdout or 'No stdout logged.' }}</pre>
      {% if analysis.stderr %}
        <div class="alert alert-danger small mt-3 mb-0">{{ analysis.stderr }}</div>
      {% endif %}
    </div>
  </div>
{% else %}
  <div class="alert alert-warning">Capture report missing. Please re-upload the file.</div>
{% endif %}
{% endblock %}

{% extends 'layout.html' %}
{% block body %}
<div class="row g-4">
  <div class="col-12 col-xxl-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
          <div>
            <h1 class="h4 mb-1">Security operations</h1>
            <p class="text-muted2 mb-0">Drive the new authentication, alerting, scheduling, firewall, and detection helpers through the UI.</p>
          </div>
          {% if user %}
          <span class="badge text-bg-success">Signed in as {{ user.username }} (role: {{ user.role }})</span>
          {% else %}
          <span class="badge text-bg-secondary">Not signed in</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  <div class="col-12 col-xxl-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h2 class="h5">Quick help</h2>
        <ul class="mb-0 small text-muted2 ps-3">
          <li>Authentication is session-based. Bootstrap once, then login to call protected APIs.</li>
          <li>Alert CRUD and scheduler reloads accept the legacy <code>token</code> query parameter as a fallback.</li>
          <li>Firewall and detection helpers require the <code>analyst</code> role.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-12 col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
          <div>
            <h2 class="h5 mb-1">Authentication</h2>
            <p class="text-muted2 mb-0">Bootstrap an admin, login, or logout via session-backed APIs.</p>
          </div>
          <span class="badge text-bg-light" id="authStatus">Idle</span>
        </div>

        <form class="row gy-3" id="bootstrapForm" data-no-overlay>
          <div class="col-12">
            <label class="form-label" for="bootstrapPassword">Bootstrap admin password</label>
            <input class="form-control" id="bootstrapPassword" type="password" placeholder="Set a strong initial password" required>
          </div>
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-outline-primary">Bootstrap admin</button>
          </div>
        </form>

        <hr>

        <form class="row gy-3" id="loginForm" data-no-overlay>
          <div class="col-12">
            <label class="form-label" for="loginUsername">Username</label>
            <input class="form-control" id="loginUsername" type="text" placeholder="admin" required>
          </div>
          <div class="col-12">
            <label class="form-label" for="loginPassword">Password</label>
            <input class="form-control" id="loginPassword" type="password" placeholder="••••••••" required>
          </div>
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">Login</button>
            <button type="button" class="btn btn-outline-secondary ms-2" id="logoutBtn">Logout</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
          <div>
            <h2 class="h5 mb-1">Alert pipeline</h2>
            <p class="text-muted2 mb-0">Emit alerts, view recent entries, and acknowledge or suppress them.</p>
          </div>
          <span class="badge text-bg-light" id="alertStatus">Idle</span>
        </div>

        <form class="row gy-3" id="alertForm" data-no-overlay>
          <div class="col-md-6">
            <label class="form-label" for="alertSource">Source</label>
            <input class="form-control" id="alertSource" type="text" placeholder="manual" value="manual">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="alertSeverity">Severity</label>
            <select class="form-select" id="alertSeverity">
              <option value="info" selected>info</option>
              <option value="low">low</option>
              <option value="medium">medium</option>
              <option value="high">high</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label" for="alertMessage">Message</label>
            <input class="form-control" id="alertMessage" type="text" placeholder="Example alert message">
          </div>
          <div class="col-12">
            <label class="form-label" for="alertMetadata">Metadata (JSON)</label>
            <textarea class="form-control" id="alertMetadata" rows="3" placeholder='{"ticket": "INC-123"}'></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="alertToken">Legacy token (optional)</label>
            <input class="form-control" id="alertToken" type="text" placeholder="ENGAGEMENT_TOKEN">
          </div>
          <div class="col-md-6 text-end d-flex align-items-end justify-content-end">
            <button type="submit" class="btn btn-primary">Emit alert</button>
            <button type="button" class="btn btn-outline-secondary ms-2" id="refreshAlertsBtn">Refresh feed</button>
          </div>
        </form>

        <div class="mt-4">
          <div class="d-flex align-items-center justify-content-between mb-2">
            <h3 class="h6 mb-0">Recent alerts</h3>
            <small class="text-muted2" id="alertCountLabel">0</small>
          </div>
          <div class="list-group" id="alertFeed">
            <div class="list-group-item text-muted2 small">No alerts yet.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1">
  <div class="col-12 col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
          <div>
            <h2 class="h5 mb-1">Scheduler</h2>
            <p class="text-muted2 mb-0">Reload recurring scans and policy checks through APScheduler.</p>
          </div>
          <span class="badge text-bg-light" id="scheduleStatus">Idle</span>
        </div>
        <form class="row gy-3" id="scheduleForm" data-no-overlay>
          <div class="col-md-8">
            <label class="form-label" for="scheduleToken">Legacy token (optional)</label>
            <input class="form-control" id="scheduleToken" type="text" placeholder="ENGAGEMENT_TOKEN">
          </div>
          <div class="col-md-4 d-flex align-items-end justify-content-end">
            <button type="submit" class="btn btn-primary w-100">Reload schedules</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12 col-xl-6">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
          <div>
            <h2 class="h5 mb-1">Firewall regression</h2>
            <p class="text-muted2 mb-0">Run expected-allowed/blocked matrices against a target with Nmap/Scapy helpers.</p>
          </div>
          <span class="badge text-bg-light" id="firewallStatus">Idle</span>
        </div>
        <form class="row gy-3" id="firewallForm" data-no-overlay>
          <div class="col-12">
            <label class="form-label" for="firewallTarget">Target (host or CIDR)</label>
            <input class="form-control" id="firewallTarget" type="text" placeholder="10.0.0.0/24" required>
          </div>
          <div class="col-12">
            <label class="form-label" for="firewallExpectations">Expectations (JSON array)</label>
            <textarea class="form-control" id="firewallExpectations" rows="4" placeholder='[{"service": "ssh", "port": 22, "protocol": "tcp", "expect": "allow"}]'></textarea>
            <div class="form-text">Must be a JSON list of expectation objects with service/port/protocol/expect fields.</div>
          </div>
          <div class="col-12 text-end">
            <button type="submit" class="btn btn-primary">Run regression</button>
          </div>
        </form>
        <div class="mt-3">
          <h3 class="h6">Results</h3>
          <pre class="small bg-body-tertiary p-3 rounded" id="firewallResults">Waiting for a run…</pre>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row g-4 mt-1 mb-3">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
          <div>
            <h2 class="h5 mb-1">Detection validation</h2>
            <p class="text-muted2 mb-0">Register validation scenarios, replay PCAPs, and store pass/fail outcomes.</p>
          </div>
          <span class="badge text-bg-light" id="detectionStatus">Idle</span>
        </div>
        <div class="row gy-4">
          <div class="col-md-4">
            <h3 class="h6">Register scenario</h3>
            <form class="row gy-2" id="detectionRegisterForm" data-no-overlay>
              <div class="col-12">
                <label class="form-label" for="detectionName">Name</label>
                <input class="form-control" id="detectionName" type="text" placeholder="C2 beacon" required>
              </div>
              <div class="col-12">
                <label class="form-label" for="detectionScenario">Scenario</label>
                <textarea class="form-control" id="detectionScenario" rows="3" placeholder="Replay beacon pcap against IDS" required></textarea>
              </div>
              <div class="col-12">
                <label class="form-label" for="detectionExpected">Expected signal</label>
                <input class="form-control" id="detectionExpected" type="text" placeholder="Alert ID or rule name" required>
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-primary">Register</button>
              </div>
            </form>
          </div>
          <div class="col-md-4">
            <h3 class="h6">Replay PCAP</h3>
            <form class="row gy-2" id="detectionReplayForm" data-no-overlay>
              <div class="col-12">
                <label class="form-label" for="detectionPcap">PCAP path</label>
                <input class="form-control" id="detectionPcap" type="text" placeholder="/tmp/samples/beacon.pcap" required>
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-outline-primary">Replay</button>
              </div>
            </form>
            <pre class="small bg-body-tertiary p-3 rounded mt-2" id="detectionReplayResults">Replay results will appear here.</pre>
          </div>
          <div class="col-md-4">
            <h3 class="h6">Record outcome</h3>
            <form class="row gy-2" id="detectionResultForm" data-no-overlay>
              <div class="col-12">
                <label class="form-label" for="detectionId">Validation ID</label>
                <input class="form-control" id="detectionId" type="number" min="1" placeholder="1" required>
              </div>
              <div class="col-12">
                <label class="form-label" for="detectionResult">Result</label>
                <select class="form-select" id="detectionResult">
                  <option value="pass">pass</option>
                  <option value="fail">fail</option>
                  <option value="unknown" selected>unknown</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label" for="detectionNotes">Notes</label>
                <textarea class="form-control" id="detectionNotes" rows="2" placeholder="Link to SIEM search or triage notes"></textarea>
              </div>
              <div class="col-12 text-end">
                <button type="submit" class="btn btn-outline-primary">Record result</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function setStatus(el, text, success = false) {
    el.textContent = text;
    el.className = `badge text-bg-${success ? 'success' : 'light'}`;
  }

  function safeJsonParse(value) {
    if (!value) return null;
    try { return JSON.parse(value); }
    catch (e) { return null; }
  }

  async function postJson(url, body) {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(body || {})
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) {
      throw new Error(data.error || res.statusText || 'Request failed');
    }
    return data;
  }

  // Authentication
  const authStatus = document.getElementById('authStatus');
  document.getElementById('bootstrapForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus(authStatus, 'Bootstrapping…');
    const password = document.getElementById('bootstrapPassword').value;
    try {
      await postJson('/auth/bootstrap', { password });
      setStatus(authStatus, 'Admin bootstrapped', true);
    } catch (err) {
      setStatus(authStatus, err.message || 'Failed');
    }
  });

  document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus(authStatus, 'Signing in…');
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    try {
      await postJson('/auth/login', { username, password });
      setStatus(authStatus, `Signed in as ${username}`, true);
    } catch (err) {
      setStatus(authStatus, err.message || 'Login failed');
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    setStatus(authStatus, 'Signing out…');
    try {
      await postJson('/auth/logout', {});
      setStatus(authStatus, 'Logged out', true);
    } catch (err) {
      setStatus(authStatus, err.message || 'Logout failed');
    }
  });

  // Alerts
  const alertStatus = document.getElementById('alertStatus');
  const alertFeed = document.getElementById('alertFeed');
  const alertCountLabel = document.getElementById('alertCountLabel');

  async function loadAlerts() {
    alertStatus.textContent = 'Loading…';
    const res = await fetch('/api/alerts');
    const alerts = await res.json().catch(() => []);
    alertFeed.innerHTML = '';
    if (!alerts.length) {
      alertFeed.innerHTML = '<div class="list-group-item text-muted2 small">No alerts yet.</div>';
      alertCountLabel.textContent = '0 alerts';
    } else {
      alertCountLabel.textContent = `${alerts.length} alert${alerts.length === 1 ? '' : 's'}`;
      alerts.forEach((a) => {
        const item = document.createElement('div');
        item.className = 'list-group-item';
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-semibold">${a.source || 'unknown'} <span class="badge text-bg-secondary ms-2">${a.severity}</span></div>
              <div class="small text-muted2">${a.message || ''}</div>
              <div class="small text-muted2">${a.created_at || ''} · status: ${a.status || 'new'}</div>
            </div>
            <div class="btn-group btn-group-sm" role="group">
              <button class="btn btn-outline-secondary" data-action="ack" data-id="${a.id}">Ack</button>
              <button class="btn btn-outline-secondary" data-action="suppress" data-id="${a.id}">Suppress</button>
            </div>
          </div>`;
        alertFeed.appendChild(item);
      });
    }
    alertStatus.textContent = 'Idle';
  }

  alertFeed.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const action = btn.dataset.action;
    const id = btn.dataset.id;
    try {
      alertStatus.textContent = action === 'ack' ? 'Acknowledging…' : 'Suppressing…';
      if (action === 'ack') {
        await postJson(`/api/alerts/${id}/ack`, {});
      } else {
        await postJson(`/api/alerts/${id}/suppress`, { minutes: 30 });
      }
      await loadAlerts();
      alertStatus.textContent = 'Updated';
    } catch (err) {
      alertStatus.textContent = err.message || 'Action failed';
    }
  });

  document.getElementById('alertForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus(alertStatus, 'Emitting…');
    const metadata = safeJsonParse(document.getElementById('alertMetadata').value);
    const payload = {
      source: document.getElementById('alertSource').value,
      severity: document.getElementById('alertSeverity').value,
      message: document.getElementById('alertMessage').value,
      metadata,
    };
    const token = document.getElementById('alertToken').value;
    const url = token ? `/api/alerts?token=${encodeURIComponent(token)}` : '/api/alerts';
    try {
      await postJson(url, payload);
      setStatus(alertStatus, 'Alert queued', true);
      await loadAlerts();
    } catch (err) {
      setStatus(alertStatus, err.message || 'Failed');
    }
  });

  document.getElementById('refreshAlertsBtn').addEventListener('click', loadAlerts);

  // Scheduler
  const scheduleStatus = document.getElementById('scheduleStatus');
  document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus(scheduleStatus, 'Reloading…');
    const token = document.getElementById('scheduleToken').value;
    const url = token ? `/api/schedules/reload?token=${encodeURIComponent(token)}` : '/api/schedules/reload';
    try {
      await postJson(url, {});
      setStatus(scheduleStatus, 'Reloaded', true);
    } catch (err) {
      setStatus(scheduleStatus, err.message || 'Failed');
    }
  });

  // Firewall regression
  const firewallStatus = document.getElementById('firewallStatus');
  const firewallResults = document.getElementById('firewallResults');
  document.getElementById('firewallForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus(firewallStatus, 'Running…');
    firewallResults.textContent = 'Running firewall regression…';
    const target = document.getElementById('firewallTarget').value;
    const expectations = safeJsonParse(document.getElementById('firewallExpectations').value) || [];
    try {
      const data = await postJson('/api/firewall/run', { target, expectations });
      firewallResults.textContent = JSON.stringify(data, null, 2);
      setStatus(firewallStatus, 'Completed', true);
    } catch (err) {
      firewallResults.textContent = err.message || 'Run failed';
      setStatus(firewallStatus, 'Failed');
    }
  });

  // Detection validation
  const detectionStatus = document.getElementById('detectionStatus');
  const detectionReplayResults = document.getElementById('detectionReplayResults');

  document.getElementById('detectionRegisterForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus(detectionStatus, 'Registering…');
    const payload = {
      name: document.getElementById('detectionName').value,
      scenario: document.getElementById('detectionScenario').value,
      expected_signal: document.getElementById('detectionExpected').value,
    };
    try {
      await postJson('/api/detections/register', payload);
      setStatus(detectionStatus, 'Scenario registered', true);
    } catch (err) {
      setStatus(detectionStatus, err.message || 'Failed');
    }
  });

  document.getElementById('detectionReplayForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus(detectionStatus, 'Replaying…');
    detectionReplayResults.textContent = 'Replaying…';
    try {
      const data = await postJson('/api/detections/replay', { pcap_path: document.getElementById('detectionPcap').value });
      detectionReplayResults.textContent = JSON.stringify(data, null, 2);
      setStatus(detectionStatus, 'Replay complete', true);
    } catch (err) {
      detectionReplayResults.textContent = err.message || 'Replay failed';
      setStatus(detectionStatus, 'Failed');
    }
  });

  document.getElementById('detectionResultForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    setStatus(detectionStatus, 'Recording…');
    const validationId = document.getElementById('detectionId').value;
    const payload = {
      result: document.getElementById('detectionResult').value,
      notes: document.getElementById('detectionNotes').value,
    };
    try {
      await postJson(`/api/detections/${validationId}/result`, payload);
      setStatus(detectionStatus, 'Recorded', true);
    } catch (err) {
      setStatus(detectionStatus, err.message || 'Failed');
    }
  });

  loadAlerts();
</script>
{% endblock %}
